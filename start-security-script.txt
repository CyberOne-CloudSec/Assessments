#try { git --version } catch { Start-Process winget -ArgumentList "install", "--id", "Git.Git", "-e", "--source", "winget" -Verb RunAs -Wait }; Start-Process powershell -ArgumentList "-Command Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force" -Verb RunAs -Wait; try { Rename-Item -Path "$env:USERPROFILE\Downloads\start-security-script.txt" -NewName "start-security-script.ps1" -ErrorAction Stop } catch {}; Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$env:USERPROFILE\Downloads\start-security-script.ps1`"" -Verb RunAs -Wait; Exit

# Define dynamic OutPath
$timestamp = (Get-Date).ToString("MM.dd.yyyy_HH.mm.ss")

$assessmentPath = Join-Path -Path ([Environment]::GetFolderPath('MyDocuments')) -ChildPath ("C1 Security Assessment $timestamp")
if (Test-Path -Path $assessmentPath) {Remove-Item $assessmentPath -Recurse -Force}
New-Item $assessmentPath -Type Directory
git clone https://github.com/CyberOne-CloudSec/Assessments $assessmentPath

$m365OutPath = $assessmentPath + "\M365SAT"
if (-not (Test-Path -Path $m365OutPath)) {New-Item -Path $m365OutPath -ItemType Directory | Out-Null}

$m365OutPathReport = $assessmentPath + "\M365SAT-Report"
if (-not (Test-Path -Path $m365OutPathReport)) {New-Item -Path $m365OutPathReport -ItemType Directory | Out-Null}

$azskOutPath = $assessmentPath + "\AzSK"
if (-not (Test-Path -Path $azskOutPath)) {New-Item -Path $azskOutPath -ItemType Directory | Out-Null}

$licenseOutPath = $assessmentPath + "\Microsoft License"
if (-not (Test-Path $licenseOutPath)) {New-Item -Path $licenseOutPath -ItemType Directory | Out-Null}

# UNBLOCK FILES
$files = Get-ChildItem $assessmentPath -Recurse -File
foreach ($file in $files) {
    try {
        Unblock-File -Path $file.FullName -ErrorAction Stop
    } catch {
        Write-Warning "Failed to unblock file: $($_.Exception.Message)"
    }
}

$userPrincipalName = $(Write-Host "Enter Global Admin credentials: " -f yellow -NoNewLine; Read-Host)
$tenantId = $(Write-Host "Enter Tenant Id: " -ForegroundColor Yellow -NoNewLine; Read-Host)

#RUN MICROSOFT LICENSE REVIEW
Set-Location $licenseOutPath
.\license_review.ps1 $licenseOutPath

#RUN M365SAT
Set-Location $m365OutPath
.\M365SATTester.ps1 $m365OutPathReport $userPrincipalName

#RUN M365SAT
Set-Location $azskOutPath
.\AzSK-Start.ps1 $tenantId $azskOutPath $assessmentPath

#CLEAN UP
$executePs1Path = Join-Path -Path $env:USERPROFILE -ChildPath "Downloads\start-security-script.ps1"

Remove-Item -Path $executePs1Path -Recurse -Force

Remove-Item -Path "$assessmentPath\start.ps1" -Force
Remove-Item -Path "$assessmentPath\start-security-script.txt" -Force
Remove-Item -Path "$assessmentPath\execute-m365sat.txt" -Force
Remove-Item -Path "$licenseOutPath\license_review.ps1" -Force
Remove-Item -Path "$azskOutPath\AzSK-Start.ps1" -Force
Remove-Item -Path "$assessmentPath\M365" -Recurse -Force

ii $assessmentPath

Write-Host "Press any key to exit..."
[void][System.Console]::ReadKey($true)
